steel.d("utils/uploader",[],function(e,t,a){STK.register("utils.uploader",function(e){var t=1048576,a={gif:"image/gif",jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png",tif:"image/tiff",tiff:"image/tiff",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",dot:"application/msword",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",pps:"application/vnd.ms-powerpoint",pot:"application/vnd.ms-powerpoint",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xlc:"application/vnd.ms-excel",xlm:"application/vnd.ms-excel",xlt:"application/vnd.ms-excel",pdf:"application/pdf",mpp:"application/vnd.ms-project",txt:"text/plain",text:"text/plain",wps:"application/vnd.ms-works",wdb:"application/vnd.ms-works",rtf:"application/rtf,text/rtf",htm:"text/html",html:"text/html",xhtml:"application/xhtml+xml",xml:"application/xml,text/xml",js:"text/javascript,application/javascript",json:"application/json",css:"text/css",csv:"text/csv",zip:"aplication/zip",dtd:"application/xml-dtd",asf:"application/vnd.ms-asf","3gpp":"audio/3gpp,video/3gpp",ac3:"audio/ac3",ogg:"application/ogg,audio/ogg",mp3:"audio/mpeg",mp2:"audio/mpeg,video/mpeg",mp4:"audio/mp4,video/mp4",au:"audio/basic",mpeg:"video/mpeg",mpg:"video/mpeg"},i={img:"jpg,png,gif,jpeg,bmp",doc:"doc,docx,xls,xlsx,ppt,pptx,pdf,txt"};return function(r,o){function p(){var t=e.$("input[node-type=uploadBtn]",r),a=t.parentNode,i=a.innerHTML;a.innerHTML=i,h.setUploadBtnAttr()}if(!r)throw new Error("必需的node节点 不存在");var n,l,d,g,c={},m=e.parseParam({width:230,height:140,maxFileNum:1,maxFileSize:5,fileFilter:"img",isOriginal:!0,imgMaxWidth:512,imgMaxHeight:200,upServer:"",fileExtensions:"",uploaded:e.empty,loading:e.empty,error:e.empty,readed:e.empty,storageType:1,callback:e.empty,data:{}},o),s={fileSelected:function(a){a.stopPropagation(),a.preventDefault(),p(),g=e.toArray(a.target.files||[]);var i=g.length;if(i){if(i>m.maxFileNum){var r={msg:"[fileNumberError]最多选择"+m.maxFileNum+"个文件",type:"error",code:"100002"};return v.trigger("error",r),void(m.error&&m.error(r))}for(var o=0;i>o;o++){if(g[o].size>m.maxFileSize*t){var r={msg:"[fileSizeError]文件大小超出"+Math.round(m.maxFileSize)+"M",type:"error",code:"100003"};return v.trigger("error",r),void(m.error&&m.error(r))}var n=v.getFileExtType(g[o].name);if(d.indexOf(n)<0){var r={msg:"[fileTypeError]文件类型错误，仅支持上传"+d.join(",")+"类型文件",type:"error",code:"100004"};return v.trigger("error",r),void(m.error&&m.error(r))}}u.handleFile(g),x.uploading()}}},u={handleFile:function(){if(0!=g.length){var e=new FileReader;e.onload=u.onLoad,e.onprogress=u.onProgress;var t=g.shift();e.filename=t.name,e.readAsDataURL(t)}},onLoad:function(t){!m.isOriginal&&m.imgMaxWidth&&m.imgMaxHeight&&!e.os.ios?f.crop(t.target.result,t.target.filename):x.readed(t.target.result,t.target.filename)},onProgress:function(e){if(e.lengthComputable){var t=Math.round(e.loaded/e.total*100);100>t&&x.uploading(t)}}},f={crop:function(t,i){var r=v.getFileExtType(i);t="data:"+a[r]+";base64,"+t.split(",")[1],n||(n=new Image),l||(l=e.C("canvas")),n.onload=function(){var e,t,a,r,o,p=n.width,d=n.height,g=m.imgMaxWidth,c=m.imgMaxHeight,s=p/g,u=d/c;l.width=g,l.height=c,s>u?(e=u,r=g*e,o=c*e,t=Math.abs((r-p)/2),a=0):(e=s,r=g*e,o=c*e,t=0,a=Math.abs((o-d)/2)),l.getContext("2d").drawImage(n,t,a,r,o,0,0,g,c),x.readed(l.toDataURL(),i)},n.src=t}},x={uploading:function(e){var t={msg:"上传中",type:"uploading",data:e,code:"100004"};v.trigger("uploading",t),m.uploading&&m.uploading(t)},uploaded:function(e){var t={msg:"上传完成",type:"uploaded",data:e,code:"100000"};v.trigger("completed",t),m.uploaded&&m.uploaded(t)},error:function(e){var t={msg:"网络繁忙，请重试！",type:"error",data:e,code:"100005"};v.trigger("error",t),m.error&&m.error(t)},readed:function(t,a){var i=e.merge({data:v.encode(t),storageType:m.storageType,filename:a},m.data);e.ajax({type:"post",url:m.upServer||"/v1/widgets/interface/proxy?api=interface/picture/upload",data:i,timeout:15e3,dataType:"json",onComplete:function(e){x.uploaded(e.data)},onFail:function(e){x.error(),u.handleFile()},onTimeout:function(){x.error(),u.handleFile()}});var r={msg:"文件已获取",type:"readed",data:t,code:"100006"};m.readed&&m.readed(r),v.trigger("readed",r)}},v={trigger:function(t,a){e.trigger(c,t,a),m.callback&&m.callback(a)},encode:function(e){return e.replace(/\&/g,"&amp;").replace(/"/g,"&quot;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\'/g,"&#39;").replace(/\u00A0/g,"&nbsp;").replace(/(\u0020|\u000B|\u2028|\u2029|\f)/g,"&#32;")},getFileExtType:function(e){var t=e.split(".")[1];return"img"===m.fileFilter&&void 0===t&&(t="jpg"),t}},h={setUploadBtnAttr:function(){var t=e.$("input[node-type=uploadBtn]",r);if(!d){d=m.fileExtensions?m.fileExtensions.split(","):i[m.fileFilter].split(",");for(var o=[],p=0,n=d.length;n>p;p++)o.push(a[d[p]]);m.maxFileNum<2&&t.removeAttribute("multiple"),t.setAttribute("accept",o.join(","))}e.once(t,"change",s.fileSelected)}};return p(),c.destroy=function(){n=l=d=null,s=x=v=null,h=u=f=null},c}})});